Ip作为整个TCP/IP中至关重要的协议，主要负责将数据包发送给最终的目标计算机。因此，IP能够让世界上任何两台计算机之间进行通信。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/ISO%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B.png)


# IP即网际协议

TCP/IP的心脏是互联网层。这一层主要由IP(Internet Protocol)和ICMP(Internet Control Message Protocol)两个协议组成。

## IP相当于OSI参考模型中的第3层

IP相当于OSI参考模型中的第3层——网络层。

网络层的主要作用是“实现终端节点之间的通信”。这种终端节点之间的通信也叫“点对点(end-to-end)通信”。

从前面的张杰可知，网络层的下一层——数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传输。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/1_IP%E7%9A%84%E4%BD%9C%E7%94%A8.png)

### 主机和节点

在互联网世界中，将那些配有IP地址的设备叫做“主机”。这里的主机可以是超大型计算机，也可以是小型计算机。习惯上将配有IP地址的设备称为“主机”。  
然而，准确地说，主机的定义应该是指“配置有IP地址，但是不进行路由控制的设备”。既配有IP地址又具有路由控制能力的设备叫做“路由器”，跟主机有所区别。而节点则是主机和路由器的统称。

## 网络层与数据链路层的关系

数据链路层提供直连的两个设备之间的通信功能。与之相比，作为网络层的IP则负责在没有直连的两个网络之间进行通信传输。  
用旅行为例说明这个问题。有个人要去一个很远的地方旅行，并且计划先后乘坐飞机、火车、公交车到达目的地。为此，他决定先去旅行社购买机票和火车票。  
旅行社不仅为他预定好了旅途过程中所需要的机票和火车票，甚至为他指定了一个详细行程表，详细到几点积分需要乘坐飞机或火车都一目了然。  
当然，机票和火车票只有特定区间内有效，当你换乘不同公司的飞机或火车时，还需要重新购票。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/2_IP%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E7%9A%84%E4%BD%9C%E7%94%A8.png)

仔细分析一下机票和火车票，不难发现，每张票只能在某一限定区间内移动。此处的“区间内”就如同通信网络上的数据链路。而这个区间内的出发地点和目的地点就如同某一个数据链路的源地址和目标地址等首部信息。整个全程的行程表的作用就相当于网络层。  
如果我们只有行程表而没有车票，就无法搭乘交通工具到达目的地。反之，如果除了车票其他什么都没有，恐怕也很难到达目的地。因为你不知道该坐陈么车，也不知道该在哪里换乘。因此，只有两者兼备，既有某个区间的车票又有整个旅行的行程表，才能保证到达目的地。与之类似，计算机网络中也需要数据链路层和网络层这个分层才能实现向最终目标地址的通信。

## IP基础知识

Ip大致分为三大作用模块，它们是IP寻址、路由(最终节点为止的转发)以及Ip分包与组包。

### IP地址属于网络层地址

在计算机通信中，为了识别通信对端，必须要有一个类似于地址的识别码进行标识。前面我们介绍过数据链路的MAC地址。MAC地址正是用来标识同一个链路中不同计算机的一种识别码。  
作为网络层的IP，也有这种地址信息。一般叫做IP地址。IP地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”。因此，在TCP/IP通信中所有主机或路由器必须设定自己的IP地址。  

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/3_IP%E5%9C%B0%E5%9D%80.png)

不论一台主机与哪种数据链路连接，其IP地址的形式都保持不变。以太网、无线局域网、PPP等，都不会改变IP地址的形式。

### 路由控制

路由控制(Routing)是指将分组数据发送到最终目标地址的功能。即使网络非常复杂，也可以通过路由控制确定到达目标地址的通路。一旦这个路由控制的运行出现异常，分组数据极有可能"迷失"，无法到达目标地址。因此，一个数据包之所以能够成功地到达最终的目标地址，全靠路由控制。  
![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/4_%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6.png)

#### 发送数据至最终目标地址

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/5_%E8%B7%AF%E7%94%B1.png)

IP数据包的传输亦是如此。可以将旅行看做IP数据包，将车站和工作人员看做路由器。当某个IP包到达路由器时，路由器首先查找其目标地址，从而再决定下一步应该将这个包发往哪个路由器，然后将包发送过去。当这个IP包到达那个路由器以后，会再次经理查找下一目标地址的过程，并由该路由器转发给下一个被找到的路由器。这个过程可能会反复多次，直到找到最终的目标地址将数据包发给这个节点。  
这里还可以用快递的送货方式来打比方。IP数据包犹如包裹，而送货车犹如数据链路。包裹不可能自己移动，必须有送货车承载转运。而一辆送货车只能将包裹送到某个区间范围内。每个不同区间的包裹将由对应的送货车承载、运输。IP的工作原理也是如此。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/6_IP%E5%8C%85%E7%9A%84%E5%8F%91%E9%80%81.png)

#### 路由控制表

为了将数据包发送给目标主机，所有主机都维护着一张路由控制表(Routing Table)。该表记录IP数据在下一步应该发给哪个路由器。IP包将根据这个路由表在各个数据链路上传输。  

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/7_%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6%E8%A1%A8.png)

### 数据链路的抽象化

IP是实现多个数据链路之间通信的协议。数据链路根据种类的不同各有特点。对这些不同数据链路的相异特性抽象化也是IP的重要作用之一。数据链路的地址可以被抽象化为IP地址。因此，对IP的上一层来说，不论底层数据链路使用以太网还是无线LAN亦或是PPP，都将被一视同仁。  
不同数据链路有个最大的区别，就是它们各自的最大传输单位(MTU:Maximum Transmission Unit)不同。就好像人们在邮寄包裹时有各自的大小限制一样。  

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/8_%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E7%9A%84%E6%9C%80%E5%A4%A7%E4%BC%A0%E8%BE%93%E5%8D%95%E4%BD%8D.png)

MTU的值在以太网中是1500字节，在FDDI中是4352字节。IP的上一层可能会要求传送比这些MTU等多字节的数据，因此必须在线路上传送比包长还要小的MTU。(不知道这句话是翻译错了，反正我是看不懂。)  
为了解决这个问题，IP进行分片处理(IP Fragmentation)。顾名思义，所谓分片处理是指，将较大的IP包分成多个较小的IP包。分片的包到了对端目标地址以后会再被组合起来传给上一层。即从IP的上层次看，它完全可以忽略数据包在途中的各个数据链路上的MTU，而只需要按照源地址发送的长度接受数据包。IP就是以这种方式抽象化了数据链路层，使得从上层更不容易看到底层网络构造的细节。  

### IP属于面向无连接型

IP面向无连接。即在发包之前，不需要建立与对端目标地址之间的连接。上层如果遇到需要发送给IP的数据，该数据会立即被压缩成IP包发送出去。  
在面向有连接的情况下，需要事先建立连接。如果对端主机关机或不存在，也就不可能建立连接。反之，一个没有建立连接的主机也不可能发送数据过来。  
而面向无连接的情况则不同。即使对端主机关机或不存在，数据包还是会被发送出去。反之，对于一台主机来说，它会何时从哪里收到数据也是不得而知的。通常应该进行网络监控，让主机只接收发给自己的数据包。若没有做好准备很有可能会错过一些该收的包。因此，在面向无连接的方式下可能会有很多冗余的通信。  
IP为什么要采用面向无连接呢？  
主要有两点原因：一是为了简化，二是为了提速。面向有连接比面向无连接处理相对复杂。甚至管理每个连接本身就是一个相当繁琐的事情。此外，每次通信之前都要事先建立连接，又会降低处理速度。需要有连接时，可以委托上一层提供此项服务。因此，IP为了实现简单化与高速化采用面向无连接的方式。  

* 为了提高可靠性，上一层的TCP采用面向有连接型

> IP提供尽力服务(Best Effort)，意指“为了把数据包发送到最终目标地址，尽最大努力”。然而，它并不做“最终收到与否的验证”。IP数据包在途中可能会发生丢包、错位以及数据量翻倍等问题。如果发送端的数据未能真正发送到对端目标主机会造成严重的问题。  
> 因此提高通信的可靠性很重要。TCP就提供这种功能。如果说IP只负责将数据发给目标主机，那么TCP则负责保证对端主机确实接收到数据。

# IP地址的基础知识

在用TCP/IP通信时，用IP地址识别主机和路由器。为了保证正常通信，有必要为每个设备配置正确的IP地址。在互联网通信中，全世界都必须设定正确的IP地址。否则，根本无法实现正常的通信。  
因此，IP地址就像是TCP/IP通信的一块基石。

## IP地址的定义

IP地址(IPv4)由32位二进制表示。TCP/IP通信要求将这样的IP地址分配给每一个参与通信的主机。IP地址在计算机内部以二进制方式被处理。为了人们读写方便，采用“点分十进制”的方式表示。

## IP地址由网络和主机两部分标识组成

如下图所示，网络标识在数据链路的每个段配置不同的值。网络标识必须保证相互连接的每个段的地址不相重复。而相同段内相连的主机必须有相同的网络地址。IP地址的“主机标识”则不允许在同一个网段内重复出现。  

由此，可以通过设置网络地址和主机地址，在相互连接的整个网络中保证每台主机的IP地址都不会相互重叠。即IP地址具有了唯一性。


![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/9_IP%E5%9C%B0%E5%9D%80%E7%9A%84%E4%B8%BB%E6%9C%BA%E6%A0%87%E8%AF%86.png)

如下图所示，IP包被转发到途中某个路由器时，正是利用目标IP地址的网络标识进行路由。因为即使不看主机标识，只要一见到网络标识就能判断出是否为该网段内的主机。

一个IP地址有32位，那么从第几位到第几位算是网络地址，从第几位到第几位算是主机地址呢？现在一般用子网掩码区分。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/10_IP%E5%9C%B0%E5%9D%80%E7%9A%84%E7%BD%91%E7%BB%9C%E6%A0%87%E8%AF%86.png)

##　IP地址的分类

IP地址分为四个级别，分别为A类、B类、C类、D类(还有一个一直未使用的E类)。它根据IP地址中从第一位到第四位的比特列对其网络标识和主机标识进行区分。

### A类地址

A类地址是首位以“0”开头的地址。从第1位到第8位是它的网络标识。用十进制表示的话，0.0.0.0~127.0.0.0是A类的网络地址。后24位相当于主机标识。因此，一个网段内可容纳的主机地址上限为16,777,214个。

### B类地址

B类IP地址是前两位为“10”的地址。从第1位到第16位是它的网络标识。用十进制表示的话，128.0.0.1~191.255.0.0是B类的网络地址。B类地址的后16位相当于主机标识。因此，一个网段内可容纳的主机地址上限为65534个。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/11_IP%E5%9C%B0%E5%9D%80%E7%9A%84%E5%88%86%E7%B1%BB.png)

### C类地址

C类Ip地址是前三位为“110”的地址。从第1位到第24位是它的网络标识。用十进制表示的话，192.168.0.0~239.255.255.0是C类的网络地址。C类地址的后8位相当于主机标识。因此，一个网段内可容纳的主机地址上限为254个。

### D类地址

D类IP地址是前四位为“1110”的地址。从第1位到第32位是它的网络标识。用十进制表示的话，224.0.0.0~239.255.255.255是D类的网络地址。D类地址没有主机标识，常被用于多播。

## 子网掩码

一个IP地址只要确定了其分类，也就确定了它的网络标识和主机标识。例如A类地址前8位(除首位"0"还有7位)、B类地址前16位(除首位"10"还有14位)、C类地址前24位(除首位"110"还有21位)分别是它们各自的网络标识部分。

现在，一个IP地址的网络标识和主机标识已不再受限于该地址的类别，而是由一个叫做“子网掩码”的识别码通过子网网络地址细分出比A类、B类、C类更小粒度的网络。这种方式实际上就是将原来的A类、B类、C类等分类中的主机地址部分用作 **子网地址** ，可以将原网络分为多个物理网络的一种机制。

自从引入了子网以后，一个IP地址就有了两种识别码。一是IP地址本身，另一个是表示网络部的子网掩码。子网掩码用二进制方式表示的话，也是一个32位的数字。它对应IP地址网络标识部分的位全部为“1”，对应IP地址主机标识的部分则全部为“0”。由此，一个IP地址可以不再受限于自己的类别，而是可以用这样的子网掩码自由地定位自己的网络标识长度。当然，子网掩码必须是IP地址的首位开始连续的“1”。

子网掩码可以灵活地指定网络标识的长度

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/12_%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%8F%AF%E4%BB%A5%E7%81%B5%E6%B4%BB%E6%8C%87%E5%AE%9A%E7%BD%91%E7%BB%9C%E6%A0%87%E8%AF%86%E7%9A%84%E9%95%BF%E5%BA%A6.png)

# 路由控制

发送数据包时所使用的地址是网络层的地址，即IP地址。然而仅仅有了IP地址还不足以实现将数据包发送到对端目标地址，在数据发送过程中还需要类似于“指明路由器或主机”的信息，以便真正发往目标地址。保存这种信息的就是路由控制表(Routing Table)。实现IP通信的主机和路由器都必须持有一张这样的表。它们也正是在这个表格的基础上才得以进行数据包发送的。  
该路由控制表的形成方式有两种：一种是管理员手动设置，另一种是路由器与其他路由相互交换信息时自动刷新。前者也叫静态路由控制，而后者叫做动态路由控制。为了让动态路由及时刷新路由表，在网络上互连的路由器之间必须设置好路由协议，保证正常读取路由控制信息。  
IP协议始终认为路由表是正确的。然而，IP本身并没有定义制作路由控制表的协议。即IP没有制作路由控制表的机制。该表是由一个叫做”路由协议"(这个协议有别于IP)的协议制作而成。

## IP地址与路由控制

Ip地址的网络地址部分用于进行路由控制。下图即发送IP包的示例。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/13_%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6%E8%A1%A8%E4%B8%8EIP%E5%8C%85%E5%8F%91%E9%80%81.png)

主机A的地址是10.1.1.30，要把数据发往地址为10.1.2.10的主机。在主机A的路由表中，保存了两个字段，由于目标地址10.1.2.10与10.1.1.0/24段不匹配，所以它被发往默认路由10.1.1.1也就是图中路由器1的左侧网卡的IP地址。  

路由器1继续在它自己的路由控制表中查找目标地址10.1.2.10，它发现目标地址属于10.1.2.0/24这一段，因此将数据转发至下一个路由器10.1.0.2，也就是路由器2的左侧网卡的地址。

路由器2在自己的路由控制表中查找目标地址10.1.2.10，根据表中记录将数据发往10.1.2.1接口，也就是自己的右侧网卡的IP地址。主机B检查目标IP地址和自己相同，于是就收数据。

路由控制表中记录着网络地址与下一步应该发送至路由器的地址。在发送IP包时，首先要确定IP包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将IP包转发给相应的下一个路由器。如果路由控制表中存在多条相同网络地址的记录，就选择一个最为吻合的网络地址。所谓最为吻合是指相同位数最多的意思。  
例如172.20.100.52的网络地址与172.20/16和172.20.100/24两项都匹配。此时，应该选择匹配度最长的172.20.100/24。此外，如果路由表中下一个路由器的位置记录着某个主机或路由器网卡的IP地址，那就意味着”发送的目标地址属于同一个链路“。

###默认路由

如果一张路由表中包含所有的网络及其子网络的信息，将会造成浪费。这时，默认路由(Default Route)是不错的选择。默认路由是指路由表中任何一个地址都能与之匹配的记录。  
默认路由一般标记为0.0.0.0/0或default。这里的0.0.0.0/0并不是指IP地址是0.0.0.0.由于后面是“/0”，所以并没有标识IP地址。它只是为了避免人们误以为0.0.0.0是IP地址。有时默认路由也被标记为default，但是在计算机内部和路由协议的发送过程中还是以0.0.0.0/0进行处理。

### 回环地址

回环地址是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址。计算机使用一个特殊的IP地址127.0.0.1作为回环地址。与该地址具有相同意义的是一个叫做localhost的主机名。使用这个IP或主机名时，数据包不会流向网络。

## 路由控制表的聚合

利用网络地址的比特分布可以有效地进行分层配置。对内即使有多个子网掩码，对外呈现出的也是同一个网络地址。这样可以更好地构建网络，通过路由信息的聚合可以有效地减少路由表的条目。  
如下图所示，在聚合之前需要6条路由记录，聚合之后只需要2条记录。  
能够缩小路由表的大小是它最大的优势。路由表越大，管理它所需要的内存和CPU也就越多。并且查找路由表的时间也会越长，导致转发IP数据包的性能下降。如果想要构建大规模、高性能网络，则需要尽可能削减路由表的大小。  
而且路由聚合可以将已知的路由信息传送给周围其他的路由器，以达到控制路由信息的目的。下图的例子中路由器C正是将已知192.168.2.0/24与192.168.3.0/24的网络这一信息聚合成为对“192.168.2.0/23的网络也已知”，从而进行公示。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter04/14_%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6%E8%A1%A8%E8%81%9A%E5%90%88%E7%9A%84%E4%BE%8B%E5%AD%90.png)

## IP分割处理与再构成处理
