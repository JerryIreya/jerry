TCP(Transmission Control Protocol) 和IP(Internet Protocol)是互联网的众多通信协议中最为著名的。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/ISO%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B.png)


## TCP/IP的具体含义

TCP/IP是利用IP进行通信时所必须用到的协议群的统称。具体来说，IP或ICMP、TCP或UDP、TLENET或FTP、以及HTTP等都属于TCP/IP的协议。它们与TCP或IP的关系紧密，是互联网必不可少的组成部分。TCP/IP一次泛指这些协议，因此，有时也称TCP/IP为网际协议族。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/1_TCP-IP%E5%8D%8F%E8%AE%AE%E7%BE%A4.png)


# TCP/IP协议分层模型

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/2_OSI%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B%E4%B8%8ETCP-IP%E7%9A%84%E5%85%B3%E7%B3%BB.png)

上图嘴皮双耳TCP/IP与OSI分层之间的大致关系。TCP/IP与OSI在分层模块上稍有区别。OSI参考模型注重“通信协议必要的功能是什么”，而TCP/IP则更强调“在计算机上实现协议应该开发哪种程序”

## 硬件(相当于OSI的物理层)

TCP/IP的最底层是负责数据传输的硬件，这种硬件就相当于以太网或电话线路等物理层的设备。

## 网络接口层(相当于OSI的数据链路层)

网络接口层利用以太网中的数据链路层进行通信，因此属于接口层。也就是说，把它当做让NIC(网络接口卡)起作用的“驱动程序”也无妨。驱动程序是在操作系统与硬件之间起桥梁作用的软件。计算机的外围附加设备或扩展卡，不是直接插到电脑上或电脑的扩展槽上就能马上使用的，还需要有相应驱动程序的支持。例如换了一个新的NIC网卡，不仅需要硬件，还需要软件才能真正投入使用。因此，人们常常还需要在操作系统的基础上安装一些驱动软件以便使用这些附加硬件。

## 互联网层(相当于OSI的网络层)

互联网层使用IP协议，它相当于OSI模型中的第3层网络层。IP协议基于IP地址转发分包数据。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/3_%E4%BA%92%E8%81%94%E7%BD%91%E5%B1%82.png)

IP是跨越网络传送数据包，使整个互联网都能收到数据的协议。IP协议使数据能够发送到地球的另一端，这期间它使用IP地址作为主机的标识。


## 传输层(OSI中也是传输层)

TCP/IP的传输层有两个具有代表性的协议。传输层最主要的功能就是能够让应用程序之间实现通信。


* TCP

> TCP是一种面向有连接的传输层协议。它可以保证两端通信主机之间的通信可达。TCP能够正确处理在传输过程中丢包、传输顺序乱掉等异常情况。
>
> 然而，为了建立与断开连接，有时它需要至少7次的发包收包，导致网络流量的浪费。此外，为了提高网络的利用率，TCP协议中定义了各种各样复杂的规范，因此不利于视频会议场合的使用。


* UDP

> UDP有别于TCP，它是一种面向无连接的传输层协议。UDP不会关注对端是否真的收到了传送过去的数据，如果需要检查对端是否收到分组数据包，或者对端是否连接到网络，则需要在应用程序中实现。  

## 应用层(OSI中会话层以上的分层)

TCP/IP的分层中，将OSI参考模型中的会话层、表示层和应用层的功能都集中到了应用程序中实现。

* WWW

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/4_WWW.png)

> WWW可以说是互联网能够如此普及的一个重要源动力，用户在浏览器上借助鼠标和键盘就可以轻轻松松地在网上自由地冲浪。浏览器与服务端之间通信所用的协议是HTTP(HyperText Transfer Protocol)。所传输数据的主要格式是HTML(HyperText Markup Language)。WWW中的HTTP属于OSI应用层的协议，而HTML属于表示层的协议。


* 电子邮件(E-Mail)

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/5_Email.png)

>电子邮件其实就是指在网络上发送信件。发送电子邮件时用到的协议叫做SMTP(Simple Mail Transfer Protocol)。最初只能发送文本格式的电子邮件，现在，电子邮件的格式由MIME协议扩展以后，就可以发送声音、图像等各式各样的信息。这里提到的MIME属于OSI参考模型的第6层——表示层。

* 文件传输(FTP)

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/6_FTP.png)

> 文件传输是指将保存在其他计算机硬盘上的文件转义到本地的硬盘上，或将本地硬盘的文件传送到其他机器硬盘上的意思。该过程使用的协议叫做FTP(File Transfer Protocol)。在FTP中进行文件传输时会建立两个TCP连接，分别是发出传输请求时所要用到的控制连接与实际传输数据时所有用到的数据连接。

* 远程登录(TELNET与SSH)

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/7_Telnet.png)

> TCP/IP网络中远程登录常用TELNET和SSH两种协议。

* 网络管理(SNMP)

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/8_SNMP.png)


> 在TCP/IP中进行网络管理时，采用SNMP(Simple Network Management Protocol)协议。


# TCP/IP分层模型与通信示例

## 数据包首部

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/9_%E6%95%B0%E6%8D%AE%E5%8C%85%E9%A6%96%E9%83%A8%E7%9A%84%E5%B1%82%E6%AC%A1%E5%8C%96.png)

每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息。通常，为协议提供的信息为包首部，所要发送的内容为数据。

## 发送数据包

假设甲给乙发送电子邮件，内容为：“早上好”。而从TCP/IP通信上看，是从一台计算机A向另一台计算机B发送电子邮件。步骤如下：

### 1.应用程序处理

启动应用程序新建邮件，将收件人邮箱填好，再由键盘输入邮件内容“早上好”，鼠标点击“发送”按钮就可以开始TCP/IP的通信了。

应用在发送邮件的那一刻建立TCP连接，从而利用这个TCP连接发送数据。它的过程首先是将应用的数据发送给下一层的TCP，再做实际的转发处理。

### 2.TCP模块的处理

TCP根据应用的指示，负责建立连接、发送数据以及断开连接。TCP提供将应用层发来的数据顺利发送至对端的 **可靠传输** 。

为了实现TCP的这一功能，需要在应用层数据的前端附加一个TCP首部。TCP首部中包括源端口号和目标端口号(用以识别发送主机跟接收主机上的应用)、序号(用以发送的包中哪部分是数据)以及校验和(Check Sum，用来检验数据的读取是否正常进行)。随后将附加了TCP首部的包再发送给IP。

### 3.IP模块的处理

IP将TCP传过来的TCP首部和TCP数据合起来当作自己的数据，并在TCP首部的前端再加上自己的IP首部。因此，IP数据包中IP首部后面紧跟着TCP首部，然后才是应用的数据首部和数据本身。IP首部中包含接收端IP地址以及发送端IP地址。紧随IP首部的还有用来判断其后面数据是TCP还是UDP的信息。

IP包生成后，参考路由控制表决定接受此IP包的路由或主机。随后，IP包将被发送给连接这些路由器或主机网络接口的驱动程序，以实现真正发送数据。

### 4.网络接口(以太网驱动)的处理

从IP传过来的IP包，对于以太网驱动来说不过就是数据。给这数据附加上以太网首部并进行发送处理。以太网首部中包含接收端MAC地址、发送端MAC地址以及标志以太网类型的以太网数据的协议。根据上述信息产生的以太网数据包将通过物理层传输给接收端。发送处理中的FCS有硬件计算，添加到包的最后。设置FCS的目的是为了判断数据包是否由于噪声而被破坏。

以上TCP/IP的整个流程：

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/10_TCP-IP%E5%90%84%E5%B1%82%E5%AF%B9%E9%82%AE%E4%BB%B6%E7%9A%84%E6%94%B6%E5%8F%91%E5%A4%84%E7%90%86.png)

## 经过数据链路的包

分组数据包经过以太网的数据链路时的大致流程如下图所示，该图对各个包首部做了简化。

包流动时，从前往后一次被附加了以太网首部、Ip包首部、TCP包首部(或者UDP包首部)以及应用自己的包首部和数据。而包的最后则追加了以太网包尾。

每个包首部中至少都会包含两个信息：一个是发送端和接收端地址，另一个是上一层的协议类型。

经过每个协议分层时，都必须有识别包发送端和接收端的信息。以太网会有MAC地址，IP会用IP地址，而TCP/UDP则会用端口号作为识别两端主机的地址。即使在应用程序中，像电子邮件地址这样的信息也是一种地址标识。这些地址信息都在每个包经由各个分层时，附加到协议对应的包首部里面。

![](https://raw.githubusercontent.com/JerryIreya/Image/master/%E5%9B%BE%E8%A7%A3TCP-IP/Chapter02/11_%E5%88%86%E5%B1%82%E4%B8%AD%E7%9A%84%E5%8C%85%E7%BB%93%E6%9E%84.png)

此外，每个分层的包首部中还包含一个识别位，它是用来识别上一层协议的种类和信息。例如以太网的包首部中的以太网类型，IP中的协议类型以及TCP/UDP中两个端口的端口号等都起着识别协议类型的作用。就是在应用的首部信息中，有时也会包含一个用来识别其数据类型的标签。

## 数据包接收处理

包的接收流程是发送流程的逆序过程。

### 5. 网络接口(以太网驱动)的处理

主机收到以太网包以后，首先从以太网的包首部找到MAC地址判断是否为发给自己的包。如果不是发给自己的包则丢弃数据。

而如果接收到了恰好是发给自己的包，就查找以太网包首部中的类型域从而确定以太网协议所传送过来的数据类型。在这个例子中数据类型显然是IP包，因此再将数据传给处理IP的子程序，如果这时不是IP而是其他诸如ARP的协议，就把数据传给ARP处理。总之，如果以太网包首部的类型域包含了一个无法识别的协议类型，则丢弃数据。

### 6. IP模块的处理

IP模块收到IP包首部及后面的数据部分以后，也做类似的处理。如果判断得出包首部中的IP地址与自己的IP地址匹配，则可接收数据并从中查找上一层的协议。如果上一层是TCP就将IP包首部之后的部分传给TCP处理；如果是UDP则将IP包首部后面的部分传给UDP处理。对于有路由器的情况下，接收端地址往往不是自己的地址，此时，需要借助路由控制表，在调查应该送达的主机或路由器以后再转发数据。

### 7.TCP模块的处理

在TCP模块中，首先会计算一下校验和，判断数据是否被破坏。然后检查是否在按照序号接收数据。最后检查端口号，确定具体的应用程序。

数据接受完毕后，接收端则发送一个“确认回执”给发送端。如果这个回执信息未能达到发送端，那么发送端会认为接收端没有接收到数据而一直反复发送。

数据被完整地接受以后，会传给由端口号识别的应用程序。

### 8.应用程序的处理

接收端应用程序会直接接收发送端发送的数据。通过解析数据可以获知邮件的收件人地址是乙的地址。如果主机B上没有乙的邮件信箱，那么主机B返回给发送端一个“无此收件地址”的报错信息。

但在这个例子中，主机B恰好有乙的收件箱，所以主机B和收件人乙能够收到电子邮件的正文。邮件会被保存到本机的硬盘上。如果保存也能正常进行，那么接收端会返回一个“处理正常”的回执给发送端。反之，一旦出现磁盘满、邮件未能成功保存等问题，就会发送一个“处理异常”的回执给发送端。

由此，用户乙就可以利用主机B上的邮件客户端，接受并阅读主机A上的用户甲所发送过来的电子邮件——“早上好”。
